# 超声波测距与报警系统项目说明文档

## 项目概述

本项目是一个基于FPGA的超声波测距系统，能够测量物体距离（0-9999mm），通过数码管实时显示测量结果，并根据不同距离范围通过蜂鸣器发出不同音高的报警提示音。

## 项目文件结构

```
├── measure.v            # 超声波测距模块（状态机控制）
├── binary2bcd.v        # 二进制转BCD码模块（加3移位算法）
├── digi_tube_drv.v     # 数码管驱动模块（动态扫描）
├── tone.v              # 音调生成模块（多频率PWM）
├── ultrasonic.v        # 系统顶层模块（集成所有功能）
```

## 系统功能与原理

### 1. 超声波测距模块 (measure.v)

**功能**：驱动超声波传感器，测量并计算物体距离。

**传感器工作原理**：
- 发送10μs触发脉冲到TRIG引脚
- 传感器发射超声波并等待回波
- 接收ECHO高电平脉冲，宽度与距离成正比
- 根据ECHO脉冲宽度计算距离

**状态机设计**：
```
IDLE → TRIG → WAIT → ECHO → DONE → IDLE
```

**状态说明**：
- **IDLE**：空闲状态，等待100ms（传感器恢复时间）
- **TRIG**：发送10μs触发脉冲（实际16μs）
- **WAIT**：等待ECHO信号变高
- **ECHO**：ECHO高电平期间计数
- **DONE**：计算距离并输出结果

**距离计算公式**：
```
距离(mm) = (echo_cnt × 343000mm/s) / (2 × 50,000,000Hz)
简化后：distance = (echo_cnt × 3597) >> 20
```
- `echo_cnt`：ECHO高电平期间的时钟计数
- 343000mm/s：声速（20℃时）
- 除以2：往返距离转为单程距离
- 使用移位代替除法优化硬件资源

### 2. 二进制转BCD模块 (binary2bcd.v)

**功能**：将16位二进制距离值转换为4位十进制BCD码。

**核心算法**：**加3移位法**（Double Dabble Algorithm）
- 硬件实现简单高效
- 支持最大9999（14位二进制）
- 输出16位BCD码（每4位一个十进制数）

### 3. 数码管驱动模块 (digi_tube_drv.v)

**功能**：驱动4位共阳极数码管动态显示距离。

**动态扫描原理**：
- 依次快速点亮4位数码管（1110→1101→1011→0111）
- 利用人眼视觉暂留效应实现同时显示
- 刷新率约892Hz，无闪烁

**时钟分频**：
```
扫描时钟 = 50MHz / 2^(13+1) ≈ 3.57kHz
每位显示时间 ≈ 0.28ms
4位循环时间 ≈ 1.12ms
刷新率 ≈ 892Hz
```

### 4. 音调生成模块 (tone.v)

**功能**：根据距离生成不同频率的报警音调。

**音调范围**：支持21个音符（低音、中音、高音各7个）

**音符频率表**（C大调）：
- 低音1（C3）：261.6Hz
- 中音1（C4）：523.3Hz  
- 高音1（C5）：1046.5Hz

**PWM生成原理**：
- 根据目标频率计算分频系数：`tone_cnt = 25,000,000 / 频率`
- 计数器达到tone_cnt时翻转输出
- 生成50%占空比的方波

### 5. 系统顶层模块 (ultrasonic.v)

**功能**：集成所有模块，实现完整的超声波测距报警系统。

**系统架构**：
```
超声波传感器 → 距离测量 → BCD转换 → 数码管显示
                    ↓
                距离判断 → 音调生成 → 蜂鸣器报警
```

**距离-音调映射**：
| 距离范围(mm) | 音符编号 | 对应音符 |
|--------------|----------|----------|
| >2000        | 0        | 静音     |
| 800-2000     | 7        | 低音7    |
| 200-800      | 9        | 中音2    |
| 100-200      | 12       | 中音5    |
| 50-100       | 15       | 高音1    |
| <50          | 17       | 高音3    |

## 关键技术特点

### 1. 硬件优化设计
- **移位代替除法**：距离计算使用`>> 20`代替`/ 1,048,576`
- **状态机控制**：精确的时序控制，资源占用少
- **动态扫描**：减少IO引脚占用，显示稳定

### 2. 实时处理能力
- 测量周期约100ms（传感器恢复时间）
- 实时显示更新，无延迟
- 音调实时响应距离变化

### 3. 可配置参数
- `CLK_FREQ`：系统时钟频率（默认50MHz）
- 距离计算公式可适应不同声速环境
- 音调映射表可自定义

## 硬件连接说明

### 超声波传感器（HC-SR04）
```
trig → 传感器TRIG引脚（输出，触发脉冲）
echo → 传感器ECHO引脚（输入，回波信号）
VCC  → 5V
GND  → GND
```

### 数码管（4位共阳极）
```
seg_sel[7:0] → 段选（a,b,c,d,e,f,g,dp）
bit_sel[3:0] → 位选（低电平有效）
VCC → 通过限流电阻接5V
```

### 蜂鸣器
```
bell → 蜂鸣器正极
GND  → 蜂鸣器负极
（建议串联100Ω电阻）
```

### 系统连接
```
clk   → 50MHz晶振
rst_n → 复位按钮（低电平复位）
```

## 性能指标

### 测量性能
- **测量范围**：20mm - 4000mm（理论值）
- **测量精度**：±3mm（常温下）
- **测量周期**：约100ms
- **分辨率**：1mm

### 显示性能
- **显示范围**：0000 - 9999
- **刷新率**：约892Hz
- **显示位数**：4位
- **亮度**：可调节（通过限流电阻）

### 音频性能
- **频率范围**：261.6Hz - 1975.5Hz
- **音调数量**：21个
- **响应时间**：实时响应

## 使用说明

### 1. 上电启动
1. 连接所有硬件
2. 上电后系统自动初始化
3. 数码管显示当前测量距离
4. 蜂鸣器根据距离发出相应音调

### 2. 距离测量
- 传感器前方不应有障碍物遮挡
- 测量物体表面应平整
- 避免在强噪声环境下使用
- 温度影响声速，高温时测量值偏大

### 3. 报警功能
- 距离越近，音调越高
- 超过2000mm时静音
- 可用于倒车雷达、障碍物报警等场景

## 应用场景

### 1. 工业测量
- 料位检测
- 物体定位
- 尺寸测量

### 2. 安防监控
- 入侵检测
- 距离报警
- 区域监控

### 3. 智能家居
- 自动感应灯
- 智能门禁
- 水位检测

### 4. 汽车电子
- 倒车雷达
- 停车辅助
- 盲区监测

### 5. 教学实验
- FPGA数字系统设计
- 传感器接口实验
- 实时信号处理

## 扩展建议

### 1. 功能扩展
- 添加温度补偿（提高精度）
- 增加LCD显示
- 添加无线传输模块
- 支持多传感器阵列

### 2. 性能优化
- 提高测量频率
- 增加滤波算法
- 优化功耗管理
- 添加校准功能

### 3. 应用扩展
- 无人机避障系统
- 机器人导航
- 智能仓储管理
- 医疗辅助设备

## 调试与故障排除

### 常见问题
1. **无显示**：检查数码管连接、电源、限流电阻
2. **测量不准**：检查传感器安装、环境温度、障碍物材质
3. **无声音**：检查蜂鸣器连接、音调模块工作状态
4. **显示闪烁**：检查扫描频率设置

### 调试方法
1. 使用示波器观察TRIG和ECHO信号
2. 测量实际ECHO脉冲宽度
3. 验证距离计算公式
4. 检查状态机转换逻辑

该项目展示了FPGA在传感器接口、实时信号处理和嵌入式系统设计方面的强大能力，是一个完整的工业级测距系统原型，适合作为FPGA应用开发和嵌入式系统设计的教学案例。