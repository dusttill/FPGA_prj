# FPGA 音乐播放器项目说明文档

## 项目概述

本项目是一个基于FPGA的数字音乐播放器系统，能够播放预存储的歌曲（如《We Don't Talk Anymore》）。系统通过精确的时钟分频生成不同音高的频率信号，驱动蜂鸣器或喇叭发声，实现完整的音乐播放功能。

## 项目文件结构

```
├── beat_ctrl.v           # 节拍控制器，产生音乐节拍时序
├── beep_drive.v          # 蜂鸣器驱动模块，生成PWM音频信号
├── freq_div.v            # 频率分频器，将系统时钟分频为音符频率
├── music_mem.v           # 音乐存储器（存储第一首歌曲数据）
├── music_we_dont_talk.v  # 音乐存储器（存储《We Don't Talk Anymore》）
├── music_player.v        # 音乐播放器顶层模块
```

## 各模块功能说明

### 1. 节拍控制器 (beat_ctrl.v)

**功能**：产生音乐播放所需的节拍时序，控制音符的持续时间。

**工作原理**：
- 支持两种节拍速度：八分音符（250ms）和十六分音符（125ms）
- 使用计数器实现精确的定时：`CNT_250MS = 12,500,000`（250ms/20ns）
- 输出节拍计数器`beat_cnt2`，每125ms自动加1
- 可根据需要切换不同的节拍速度

**关键参数**：
- `CNT_250MS = 12,500,000`（对应250ms，50MHz时钟）
- `CNT_125MS = 6,250,000`（对应125ms，50MHz时钟）

### 2. 频率分频器 (freq_div.v)

**功能**：根据音符编号计算对应的分频系数，将系统时钟分频为音符频率。

**工作原理**：
- 支持21个音符（低音7个、中音7个、高音7个）
- 当前配置为**E大调**音阶
- 计算公式：`div = SYS_CLK / freq`
- 其中`freq`为音符频率（Hz），`div`为分频系数

**音符映射表（E大调）**：
| 音符编号 | 频率(Hz) | 说明   |
|----------|----------|--------|
| 1        | 164      | 低音Mi |
| 2        | 185      | 低音Fa |
| 3        | 207      | 低音So |
| ...      | ...      | ...    |
| 21       | 1244     | 高音Ti |

**注释**：模块中注释掉的C大调部分可供切换使用。

### 3. 音乐存储器模块

#### 3.1 music_mem.v
**功能**：存储第一首歌曲的音符序列（64个节拍）。

**特点**：
- 使用64个节拍（6位地址）
- 每个节拍对应一个音符编号（1-21）或休止符（0）

#### 3.2 music_we_dont_talk.v
**功能**：存储歌曲《We Don't Talk Anymore》的音符序列。

**特点**：
- 使用192个节拍（8位地址），更长的歌曲
- 支持复杂的音乐节奏和旋律
- 包含休止符（0）控制

### 4. 蜂鸣器驱动模块 (beep_drive.v)

**功能**：根据分频系数生成50%占空比的PWM音频信号。

**工作原理**：
1. 使用计数器`beat_cnt2`对系统时钟进行分频
2. 当计数器值小于`div/2`时输出低电平
3. 当计数器值大于等于`div/2`时输出高电平
4. 生成方波信号驱动蜂鸣器

**输出特性**：
- 50%占空比方波
- 频率由`div`参数决定
- 复位时输出低电平（静音）

### 5. 音乐播放器顶层模块 (music_player.v)

**功能**：集成所有子模块，实现完整的音乐播放功能。

**工作流程**：
1. **节拍控制**：`beat_ctrl`产生节拍时序
2. **音符读取**：`music_we_dont_talk`根据节拍输出音符编号
3. **频率计算**：`freq_div`将音符编号转换为分频系数
4. **音频生成**：`beep_drive`根据分频系数生成音频信号
5. **音频输出**：驱动蜂鸣器发声

## 系统架构

```
      ┌─────────┐     ┌─────────────┐     ┌─────────┐
时钟 →│beat_ctrl│→节拍→│music_mem    │→音符→│freq_div │
      └─────────┘     └─────────────┘     └─────────┘
                                              ↓
                                         分频系数
                                              ↓
      ┌─────────┐                            ↓     ┌──────────┐
复位 →│music_player├───────────────────────────→分频→│beep_drive│→音频
      └─────────┘                                 └──────────┘
```

## 音乐播放原理

### 1. 音高生成原理
- 通过精确的时钟分频产生不同频率的方波
- 频率对应音乐中的音高（如C4=261.63Hz，A4=440Hz）
- 分频系数计算公式：`div = 50,000,000 / 目标频率`

### 2. 节奏控制原理
- 每个音符的持续时间由节拍控制器决定
- 八分音符：250ms
- 十六分音符：125ms
- 通过节拍计数器控制音符切换

### 3. 歌曲存储原理
- 使用查找表（ROM）方式存储音符序列
- 每个存储单元对应一个节拍时刻的音符
- 休止符（0）表示该时刻不发声

## 关键技术特点

### 1. 精确的定时控制
- 基于50MHz系统时钟，实现毫秒级精确控制
- 节拍误差小于20ns

### 2. 灵活的调式配置
- 支持C大调和E大调切换
- 可扩展其他调式

### 3. 模块化设计
- 各功能模块独立，便于维护和扩展
- 清晰的接口定义

### 4. 资源优化
- 使用查找表存储音乐数据，节省逻辑资源
- 分频计算使用整数除法，避免浮点运算

## 使用说明

### 1. 硬件连接
- `clk`：连接50MHz系统时钟
- `rst`：连接复位信号（高电平有效）
- `beep`：连接蜂鸣器或音频放大电路

### 2. 歌曲切换
- 默认播放《We Don't Talk Anymore》
- 要播放其他歌曲，在`music_player.v`中切换`music_mem`模块实例

### 3. 参数调整
- 修改`freq_div.v`中的音阶映射可改变调式
- 调整`beat_ctrl.v`中的计数值可改变播放速度
- 修改`music_*`模块可更换歌曲

## 扩展功能建议

1. **多歌曲支持**：增加歌曲选择开关
2. **音量控制**：添加PWM占空比调节
3. **音效添加**：支持颤音、延音等效果
4. **外部接口**：添加UART或SPI接口接收音乐数据
5. **显示功能**：配合数码管显示当前播放状态
6. **按键控制**：增加播放/暂停/切歌功能

## 性能指标

- **采样率**：50MHz（系统时钟）
- **频率范围**：约164Hz - 1244Hz（E大调）
- **频率精度**：±0.001Hz（理论值）
- **节拍精度**：±20ns
- **最大歌曲长度**：256个节拍（8位地址）

## 应用场景

1. **嵌入式音乐播放**：智能家居、玩具、闹钟
2. **音乐教学**：音阶演示、节奏训练
3. **报警提示**：可编程报警音
4. **FPGA教学**：数字系统设计实例

该项目展示了FPGA在音频信号生成和定时控制方面的强大能力，是一个完整的数字音乐合成系统，适合作为FPGA学习和嵌入式音频开发的实践项目。