# LED 控制与数码管显示项目说明文档

## 项目概述

本项目是一个基于FPGA的LED控制与数码管显示系统，包含多种LED显示模式（闪烁、流水、跑马、呼吸）和一个8位数码管动态扫描驱动模块。系统通过拨码开关选择不同的LED显示模式，并支持32位数据的数码管显示。

## 项目文件结构

```
├── digi_tube_drv.v      # 8位数码管动态扫描驱动模块
├── led_blink.v          # LED闪烁模块
├── led_flow.v           # LED流水灯模块
├── led_horse.v          # LED跑马灯模块
├── led_breath.v         # LED呼吸灯模块（版本1）
├── led_breathv2.v       # LED呼吸灯模块（改进版）
├── led_ctrl.v           # LED模式控制顶层模块
└── tb_led_ctrl.v        # 测试平台文件
```

## 各模块功能说明

### 1. 数码管驱动模块 (digi_tube_drv.v)

**功能**：驱动8位共阳极数码管，通过动态扫描方式显示32位数据。

**工作原理**：
- **动态扫描**：依次快速点亮每一位数码管（每位1ms，8位循环8ms，刷新率125Hz）
- **七段译码**：将0-F的十六进制数转换为对应的段码
- **消影处理**：切换位时短暂关闭显示，避免重影
- **小数点控制**：支持独立控制每位数码管的小数点显示

**接口信号**：
- `display_data[31:0]`：32位显示数据（每4位对应一个数码管）
- `dot_en[7:0]`：小数点使能信号（每位数码管对应一位）
- `seg[7:0]`：段选信号（低电平点亮）
- `sel[7:0]`：位选信号（低电平选中）

### 2. LED控制模块

#### 2.1 LED闪烁模块 (led_blink.v)
**功能**：实现8个LED同时以1秒为周期闪烁
**原理**：使用26位计数器，计满50,000,000个时钟周期（1秒）后翻转LED状态

#### 2.2 LED流水灯模块 (led_flow.v)
**功能**：实现8个LED从右向左、从左向右来回流动显示
**原理**：
- 使用32位计数器产生0.5秒的时基
- 通过左移/右移操作控制LED亮灭位置
- 到达边界时改变流动方向

#### 2.3 LED跑马灯模块 (led_horse.v)
**功能**：实现单个LED在8个位置上来回跑动
**原理**：
- 类似流水灯，但每次只有一个LED亮起
- 通过循环移位实现跑马效果
- 到达两端时改变方向

#### 2.4 LED呼吸灯模块 (led_breath.v / led_breathv2.v)
**功能**：实现LED亮度渐变（呼吸效果）

**原理**：
- **版本1**：使用固定PWM周期，通过逐步改变占空比实现亮度渐变
- **版本2**：使用256级PWM，通过更新占空比的速度控制呼吸节奏
- 亮度从0%到100%再到0%循环变化

### 3. 顶层控制模块 (led_ctrl.v)

**功能**：集成所有LED模式，通过拨码开关选择显示模式

**工作原理**：
- 实例化四个LED模块（闪烁、流水、跑马、呼吸）
- 根据2位拨码开关`sw[1:0]`选择输出模式：
  - `00`：闪烁模式
  - `01`：流水灯模式
  - `10`：跑马灯模式
  - `11`：呼吸灯模式
- 统一管理复位和时钟信号

### 4. 测试平台 (tb_led_ctrl.v)

**功能**：对LED控制模块进行仿真测试

**测试流程**：
1. 复位系统
2. 依次测试四种LED模式
3. 每个模式测试约2秒（仿真时间）
4. 生成仿真波形用于调试

## 关键技术原理

### 动态扫描技术
- 通过快速切换（1ms/位）显示位置，利用人眼视觉暂留效应实现多位数码管同时显示
- 相比静态驱动，大幅减少引脚资源占用

### PWM调光技术
- 通过调节脉冲宽度（占空比）控制LED平均亮度
- 占空比从0%到100%渐变，实现呼吸灯效果

### 状态机设计
- LED流动和跑马灯使用隐式状态机控制方向变化
- 根据当前状态和边界条件决定下一步动作

### 模块化设计
- 每个功能独立成模块，便于复用和维护
- 参数化设计支持不同时钟频率的适配

## 硬件连接说明

### LED连接
- 共阴极连接方式：低电平点亮
- 8个LED连接到`led_out[7:0]`

### 数码管连接
- 共阳极数码管：段选低电平点亮，位选低电平选中
- `seg[7:0]`：段选信号（dp, g, f, e, d, c, b, a）
- `sel[7:0]`：位选信号（sel[0]对应最低位）

### 控制信号
- `sys_clk`：系统时钟（默认50MHz）
- `rst_n`：复位信号（低电平有效）
- `sw[1:0]`：模式选择拨码开关

## 参数配置

### 时钟频率
- 默认系统时钟：50,000,000 Hz（50MHz）
- 可通过参数`CLK_FREQ`调整以适应不同硬件平台

### 时序参数
- 数码管扫描频率：1ms/位，125Hz刷新率
- LED闪烁周期：1秒
- 流水/跑马灯速度：0.5秒/步
- 呼吸灯周期：约1秒（256级PWM）

## 使用说明

1. 根据需要修改`CLK_FREQ`参数以匹配实际硬件时钟
2. 将数码管数据写入`display_data`寄存器
3. 设置`dot_en`控制小数点显示
4. 通过拨码开关`sw`选择LED显示模式
5. 复位信号`rst_n`用于初始化系统

## 扩展建议

1. 可增加更多LED显示模式
2. 可添加数码管数据更新接口
3. 可增加亮度调节功能
4. 可支持不同颜色的LED控制
5. 可添加串口通信模块实现远程控制

## 仿真与调试

1. 使用提供的测试平台进行功能验证
2. 可通过修改仿真时钟频率加速测试
3. 使用波形查看器观察LED和数码管输出信号
4. 注意观察时序是否符合预期要求

该项目展示了FPGA在数字逻辑控制和显示驱动方面的典型应用，适合作为学习FPGA开发和数字系统设计的入门项目。